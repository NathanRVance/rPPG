# Postprocess rPPG results

This step lays the groundwork for performing evaluations over the waveform predicted by the model. It ingests the .npz formatted pulse waveform as generated by [predict.py](../predict/) and generates visuals and derived data.

## Waveform Visualization

A script for plotting the waveform is included:

```shell
$ python plotWaveform.py waveform.npz output.png
```

Start and end times for plotWaveform.py may optionally be specified with --start and --end flags.

## HR Calculation

To calculate the heart rate use the script calcHR.py as follows:

```shell
$ python calcHR.py waveform.npz output.npz --plotHR hr.png
```

where waveform.npz is the pulse waveform as generated by [predict.py](../predict/), output.npz is where the calculated heart rate will be saved, and hr.png is a plot generated for heart rate over time.

The calcHR.py script defaults to using a FFT with a 10 second sliding window to calculate the heart rate. However, additional methods may be utilized by passing arguments via the `--hrCalculator` flag:

 * fft: The default short-term fourier transform technique
 * sssp: A single-source shortest path algorithm penalizing jumps in heart rate
 * peaks-scipy: A peak detector using the [scipy find\_peaks implementation](https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.find_peaks.html)
 * peaks-pyampd: A peak detector using the [pyampd find\_peaks implementation](https://github.com/ig248/pyampd)
 * cwt: A continuous wavelet transformation using the [ssqueezepy implementation](https://github.com/OverLordGoldDragon/ssqueezepy)

Finally, the resulting heart rate may be postprocessed via smoothing using the `--smooth` flag, or delta limiting (i.e., capping change in HR/time) using the `--deltaLimit` flag.

## Comprehensive Visualization

The script `annotateVideo.py` is provided as a comprehensive visualizer tool. Execute it as follows:

```shell
$ python annotateVideo.py originalVideo.avi annotatedVideo.avi
```

where originalVideo.avi is the input video, and annotatedVideo.avi is the video to be annotated. Note that in this configuration nothing will be annotated. Use the following flags to provide annotations:

 * `--waveform`: Path(s) to npz formatted waveform(s)
 * `--hrData`: Path(s) to npz formatted HR data as generated by calcHR.py
 * `--fftData`: Path(s) to npz formatted fft data as generated by calcHR.py when used with the --saveFFT flag
 * `--bboxes`: Path(s) to npz formatted bounding boxes
