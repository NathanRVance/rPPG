# Generate bounding boxes for a video

This step ingests video and produces a .npz array containing timestamped bounding box coordinates.

## Bounding box calculation

The preferred method for generating face bounding boxes is to use the [OpenFace](https://github.com/TadasBaltrusaitis/OpenFace) tool. This tool can be compiled for local use, and we have made a singularity image for use on the CRC. The script openfaceSubmit.sh can be used to calculate openface landmarks. The openfaceSubmit.sh script expects the following directory structure:
 * The singularity image is located on /scratch365/$USER/openface\_latest.sif
 * Classifiers are located on the CRC at $HOME/bin/OpenFace/lib/3rdParty/OpenCV/classifiers/. This will be the case if you clone OpenFace to ~/bin, e.g., `mkdir -p ~/bin && cd ~/bin && git clone https://github.com/TadasBaltrusaitis/OpenFace`
 * Models are located on the CRC at $HOME/bin/OpenFace/lib/local/LandmarkDetector/model/. This will by the case if, after you clone OpenFace, you execute `cd ~/bin/OpenFace && bash download_models.sh`

When running OpenFace locally, use the following command:

```shell
$ FeatureExtraction -f /path/to/video -out_dir /path/to/results -of resultsName -2Dfp
```

This will generate a csv landmarks file at `/path/to/results/resultsName.csv`.

We also support using [MediaPipe](https://github.com/google/mediapipe) for bounding box generation, though the results are not as stable as OpenFace. To use MediaPipe, execute:

```shell
$ python bboxesMp.py video.mp4 output.npz
```

Note that the output.npz file will be in the final format for this step, so formatBBoxes is not necessary.

Finally, it is also possible to use manually generated bounding boxes. The code for an OpenCV based annotation tool is included in annotator/

## Bounding box formatting

Once bounding boxes are generated by the appropriate tool, the formatBBoxes.py script can be used to convert to a standard format as follows:

```shell
$ python formatBBoxes.py input.csv output.npz
```

where input.csv is the csv file produced by openface or by the manual annotator tool, and output.npz are the bounding boxes produced by this script.
